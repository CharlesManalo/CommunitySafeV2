<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Infrastructure Reporting</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/cardnav.css') }}"
    />
  </head>
  <body>
    <!-- CardNav Header -->
    <div class="card-nav-container">
      <nav id="cardNav" class="card-nav">
        <div class="card-nav-top">
          <div
            class="hamburger-menu"
            id="hamburgerMenu"
            role="button"
            aria-label="Open menu"
            tabindex="0"
          >
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </div>

          <div class="logo-container">
            <img
              src="{{ url_for('static', filename='images/school-logo.png') }}"
              alt="OMNHS Logo"
              class="logo"
              onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/omnhs-logo.png') }}';"
            />
          </div>

          <a
            href="{{ url_for('admin_logout') }}"
            class="card-nav-cta-button"
            style="background-color: #dc3545"
            >Logout</a
          >
        </div>

        <div class="card-nav-content" id="cardNavContent" aria-hidden="true">
          <div class="nav-card" style="background-color: #0d0716; color: #fff">
            <div class="nav-card-label">Navigation</div>
            <div class="nav-card-links">
              <a
                class="nav-card-link"
                href="{{ url_for('hazard_dashboard') }}"
                aria-label="Report a hazard"
              >
                <svg
                  class="nav-card-link-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17" />
                </svg>
                Report Hazard
              </a>
              <a
                class="nav-card-link"
                href="{{ url_for('history') }}"
                aria-label="View report history"
              >
                <svg
                  class="nav-card-link-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17" />
                </svg>
                View History
              </a>
            </div>
          </div>

          <div class="nav-card" style="background-color: #170d27; color: #fff">
            <div class="nav-card-label">Admin</div>
            <div class="nav-card-links">
              <a
                class="nav-card-link"
                href="{{ url_for('admin_rfid_protected') }}"
                aria-label="RFID dashboard"
              >
                <svg
                  class="nav-card-link-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17" />
                </svg>
                RFID Dashboard
              </a>
              <a
                class="nav-card-link"
                href="{{ url_for('admin_dashboard') }}"
                aria-label="Admin dashboard"
              >
                <svg
                  class="nav-card-link-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17" />
                </svg>
                Dashboard
              </a>
            </div>
          </div>

          <div class="nav-card" style="background-color: #271e37; color: #fff">
            <div class="nav-card-label">Help</div>
            <div class="nav-card-links">
              <a
                class="nav-card-link"
                href="{{ url_for('feedback') }}"
                aria-label="Send feedback"
              >
                <svg
                  class="nav-card-link-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17" />
                </svg>
                Feedback
              </a>
              <a
                class="nav-card-link"
                href="{{ url_for('contact') }}"
                aria-label="Contact support"
              >
                <svg
                  class="nav-card-link-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17" />
                </svg>
                Contact
              </a>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <div style="height: 100px"></div>

    <div class="container">
      <header class="admin-header">
        <div class="admin-header-content">
          <h1>‚öôÔ∏è Hazard Admin Dashboard</h1>
          <div class="admin-actions">
            <span class="admin-welcome"
              >Welcome, {{ session.admin_username }}</span
            >
          </div>
        </div>
      </header>

      <div class="dashboard-stats">
        <div class="stat-card">
          <h3>Total Reports</h3>
          <p class="stat-number">{{ reports|length }}</p>
        </div>
        <div class="stat-card">
          <h3>Pending</h3>
          <p class="stat-number">
            {{ reports|selectattr('status', 'equalto', 'Pending')|list|length }}
          </p>
        </div>
        <div class="stat-card">
          <h3>Resolved</h3>
          <p class="stat-number">
            {{ reports|selectattr('status', 'equalto', 'Resolved')|list|length
            }}
          </p>
        </div>
      </div>

      <div class="admin-controls">
        <select id="admin-status-filter">
          <option value="all">All Reports</option>
          <option value="Pending">Pending Only</option>
          <option value="Resolved">Resolved Only</option>
        </select>
      </div>

      <div class="admin-reports-list" id="admin-reports-list">
        {% for report in reports %}
        <div class="admin-report-card" data-status="{{ report.status }}">
          <div class="report-header">
            <div class="report-id-section">
              <strong>Report #{{ report.id }}</strong>
              <span class="status-badge status-{{ report.status.lower() }}"
                >{{ report.status }}</span
              >
            </div>
            <div class="report-date">Reported: {{ report.date_reported }}</div>
          </div>

          <div class="report-description">
            <p>{{ report.description }}</p>
          </div>

          <div class="report-location">
            <p>
              <strong>Location:</strong> {{ "%.6f"|format(report.latitude) }},
              {{ "%.6f"|format(report.longitude) }}
            </p>
            <!-- Google Map for Admin -->
            <div class="admin-map-container">
              <iframe
                src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d15526.022196521722!2d121.1826176!3d13.3809924!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sen!2sph!4v1770049480412!5m2!1sen!2sph&q={{ report.latitude }},{{ report.longitude }}"
                width="100%"
                height="200"
                style="border: 0; border-radius: 6px"
                allowfullscreen=""
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                class="admin-map-frame"
              >
              </iframe>
              <div class="map-actions">
                <a
                  href="https://www.google.com/maps/search/?api=1&query={{ report.latitude }},{{ report.longitude }}"
                  target="_blank"
                  class="btn btn-sm btn-primary"
                >
                  üó∫Ô∏è Open in Google Maps
                </a>
              </div>
            </div>
          </div>

          <div class="report-images">
            <div class="image-section">
              <h4>üì∏ Before</h4>
              <img
                src="{{ url_for('uploaded_before_file', filename=report.before_image) }}"
                alt="Hazard before resolution"
                class="admin-hazard-image"
              />
            </div>

            {% if report.after_image %}
            <div class="image-section">
              <h4>‚úÖ After</h4>
              <img
                src="{{ url_for('uploaded_after_file', filename=report.after_image) }}"
                alt="Hazard after resolution"
                class="admin-hazard-image"
              />
            </div>
            {% endif %}
          </div>

          {% if report.status == 'Pending' %}
          <div class="resolution-section">
            <h4>üîÑ Resolve Hazard</h4>
            <div class="resolution-controls">
              <button
                class="btn btn-resolve"
                onclick="openResolutionModal('{{ report.id }}')"
              >
                üì∑ Upload Resolution Photo
              </button>
            </div>
          </div>
          {% elif report.status == 'Resolved' and report.date_resolved %}
          <div class="resolution-info">
            <p><strong>‚úÖ Resolved:</strong> {{ report.date_resolved }}</p>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Resolution Modal -->
    <div id="resolution-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üì∑ Upload Resolution Photo</h3>
          <button class="modal-close" onclick="closeResolutionModal()">
            &times;
          </button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="modal-report-id" />

          <div class="modal-camera-section">
            <video
              id="modal-camera-feed"
              autoplay
              muted
              playsinline
              style="display: none"
            ></video>
            <canvas id="modal-capture-canvas" style="display: none"></canvas>

            <div class="modal-camera-controls">
              <button id="modal-start-camera" class="btn btn-primary">
                Open Camera
              </button>
              <button
                id="modal-capture-btn"
                class="btn btn-success"
                style="display: none"
              >
                üì∑ Capture
              </button>
              <button
                id="modal-retake-btn"
                class="btn btn-secondary"
                style="display: none"
              >
                üîÑ Retake
              </button>
            </div>

            <div
              id="modal-captured-preview"
              class="modal-image-preview"
              style="display: none"
            >
              <img id="modal-captured-image" alt="Captured resolution" />
            </div>
          </div>

          <div class="modal-actions">
            <button
              id="modal-submit-resolution"
              class="btn btn-submit"
              disabled
            >
              ‚úÖ Mark as Resolved
            </button>
            <button class="btn btn-secondary" onclick="closeResolutionModal()">
              Cancel
            </button>
          </div>

          <div id="modal-status" class="modal-status"></div>
        </div>
      </div>
    </div>

    <script>
      let currentReportId = null;
      let modalCameraStream = null;

      // Modal functions
      function openResolutionModal(reportId) {
        currentReportId = parseInt(reportId);
        document.getElementById("modal-report-id").value = reportId;
        document.getElementById("resolution-modal").style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeResolutionModal() {
        document.getElementById("resolution-modal").style.display = "none";
        document.body.style.overflow = "auto";

        // Stop camera if running
        if (modalCameraStream) {
          modalCameraStream.getTracks().forEach((track) => track.stop());
          modalCameraStream = null;
        }

        // Reset modal state
        resetModalState();
        currentReportId = null;
      }

      function resetModalState() {
        document.getElementById("modal-camera-feed").style.display = "none";
        document.getElementById("modal-capture-btn").style.display = "none";
        document.getElementById("modal-retake-btn").style.display = "none";
        document.getElementById("modal-start-camera").style.display =
          "inline-block";
        document.getElementById("modal-captured-preview").style.display =
          "none";
        document.getElementById("modal-submit-resolution").disabled = true;
        document.getElementById("modal-status").innerHTML = "";
      }

      // Modal camera functionality
      document
        .getElementById("modal-start-camera")
        .addEventListener("click", async function () {
          try {
            modalCameraStream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 },
              },
            });

            const video = document.getElementById("modal-camera-feed");
            video.srcObject = modalCameraStream;
            video.style.display = "block";

            this.style.display = "none";
            document.getElementById("modal-capture-btn").style.display =
              "inline-block";
          } catch (error) {
            console.error("Error accessing camera:", error);
            alert("Unable to access camera. Please check permissions.");
          }
        });

      document
        .getElementById("modal-capture-btn")
        .addEventListener("click", function () {
          const video = document.getElementById("modal-camera-feed");
          const canvas = document.getElementById("modal-capture-canvas");
          const context = canvas.getContext("2d");

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0);

          const imageData = canvas.toDataURL("image/jpeg", 0.8);

          document.getElementById("modal-captured-image").src = imageData;
          document.getElementById("modal-captured-preview").style.display =
            "block";

          video.style.display = "none";
          this.style.display = "none";
          document.getElementById("modal-retake-btn").style.display =
            "inline-block";
          document.getElementById("modal-submit-resolution").disabled = false;
        });

      document
        .getElementById("modal-retake-btn")
        .addEventListener("click", function () {
          document.getElementById("modal-captured-preview").style.display =
            "none";
          document.getElementById("modal-camera-feed").style.display = "block";
          this.style.display = "none";
          document.getElementById("modal-capture-btn").style.display =
            "inline-block";
          document.getElementById("modal-submit-resolution").disabled = true;
        });

      // Submit resolution
      document
        .getElementById("modal-submit-resolution")
        .addEventListener("click", async function () {
          const submitBtn = this;
          const statusDiv = document.getElementById("modal-status");
          const capturedImage = document.getElementById(
            "modal-captured-image",
          ).src;
          const reportId = document.getElementById("modal-report-id").value;

          if (!capturedImage) {
            statusDiv.innerHTML =
              '<p class="text-error">‚ùå Please capture a resolution photo</p>';
            return;
          }

          // Show loading state
          submitBtn.disabled = true;
          submitBtn.textContent = "‚è≥ Processing...";
          statusDiv.innerHTML =
            '<p class="text-info">‚è≥ Uploading resolution...</p>';

          try {
            const response = await fetch(`/admin/resolve/${reportId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                after_image: capturedImage,
              }),
            });

            const result = await response.json();

            if (response.ok && result.success) {
              statusDiv.innerHTML = `
                        <p class="text-success">‚úÖ Hazard marked as resolved!</p>
                    `;

              // Reload page after delay to show updated status
              setTimeout(() => {
                location.reload();
              }, 2000);
            } else {
              throw new Error(result.error || "Unknown error occurred");
            }
          } catch (error) {
            statusDiv.innerHTML = `<p class="text-error">‚ùå Error: ${error.message}</p>`;
            submitBtn.disabled = false;
            submitBtn.textContent = "‚úÖ Mark as Resolved";
          }
        });

      // Filter functionality for admin
      document
        .getElementById("admin-status-filter")
        .addEventListener("change", function () {
          const selectedStatus = this.value.toLowerCase();
          const reportCards = document.querySelectorAll(".admin-report-card");

          reportCards.forEach((card) => {
            const cardStatus = card.getAttribute("data-status").toLowerCase();

            if (selectedStatus === "all" || cardStatus === selectedStatus) {
              card.style.display = "block";
            } else {
              card.style.display = "none";
            }
          });
        });

      // Close modal when clicking outside
      document
        .getElementById("resolution-modal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeResolutionModal();
          }
        });

      // CardNav Menu Functionality
      const hamburgerMenu = document.getElementById("hamburgerMenu");
      const cardNav = document.getElementById("cardNav");
      const cardNavContent = document.getElementById("cardNavContent");
      let isExpanded = false;

      function toggleMenu() {
        isExpanded = !isExpanded;

        if (isExpanded) {
          hamburgerMenu.classList.add("open");
          cardNav.classList.add("open");
          cardNavContent.setAttribute("aria-hidden", "false");
          hamburgerMenu.setAttribute("aria-label", "Close menu");
        } else {
          hamburgerMenu.classList.remove("open");
          cardNav.classList.remove("open");
          cardNavContent.setAttribute("aria-hidden", "true");
          hamburgerMenu.setAttribute("aria-label", "Open menu");
        }
      }

      hamburgerMenu.addEventListener("click", toggleMenu);

      // Keyboard accessibility
      hamburgerMenu.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleMenu();
        }
      });
    </script>
  </body>
</html>
