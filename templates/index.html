<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infrastructure Hazard Reporting</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/cardnav.css') }}"
    />
  </head>
  <body>
    <!-- CardNav Header -->
    <div class="card-nav-container">
      <nav id="cardNav" class="card-nav">
        <div class="card-nav-top">
          <div class="hamburger-menu" id="hamburgerMenu" role="button" aria-label="Open menu" tabindex="0">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </div>

          <div class="logo-container">
            <img src="{{ url_for('static', filename='images/school-logo.png') }}" alt="OMNHS Logo" class="logo" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/omnhs-logo.png') }}';" />
          </div>

          <div style="width: 100px;"></div>
        </div>

        <div class="card-nav-content" id="cardNavContent" aria-hidden="true">
          <!-- Navigation Card -->
          <div class="nav-card" style="background-color: #0D0716; color: #fff;">
            <div class="nav-card-label">Navigation</div>
            <div class="nav-card-links">
              <a class="nav-card-link" href="{{ url_for('hazard_dashboard') }}" aria-label="Report a hazard">
                <svg class="nav-card-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
                Report Hazard
              </a>
              <a class="nav-card-link" href="{{ url_for('history') }}" aria-label="View report history">
                <svg class="nav-card-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
                View History
              </a>
            </div>
          </div>

          <!-- Admin Card -->
          <div class="nav-card" style="background-color: #170D27; color: #fff;">
            <div class="nav-card-label">Admin</div>
            <div class="nav-card-links">
              <a class="nav-card-link" href="{{ url_for('admin_login') }}" aria-label="Admin login">
                <svg class="nav-card-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
                Admin Login
              </a>
              <a class="nav-card-link" href="{{ url_for('admin_rfid_protected') }}" aria-label="RFID dashboard">
                <svg class="nav-card-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
                RFID Dashboard
              </a>
            </div>
          </div>

          <!-- Help Card -->
          <div class="nav-card" style="background-color: #271E37; color: #fff;">
            <div class="nav-card-label">Help</div>
            <div class="nav-card-links">
              <a class="nav-card-link" href="#" aria-label="How to report guide">
                <svg class="nav-card-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
                How to Report
              </a>
              <a class="nav-card-link" href="#" aria-label="Contact support">
                <svg class="nav-card-link-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
                Contact Support
              </a>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <!-- Spacer for fixed header -->
    <div style="height: 100px;"></div>

    <div class="container">

      <div class="report-form">
        <!-- Camera Section -->
        <div class="camera-section">
          <h2>üì∏ Capture Hazard</h2>
          <div class="camera-container">
            <video id="camera-feed" autoplay muted playsinline></video>
            <canvas id="capture-canvas" style="display: none"></canvas>
            <div class="camera-controls">
              <button id="start-camera" class="btn btn-primary">
                Open Camera
              </button>
              <button
                id="capture-btn"
                class="btn btn-success"
                style="display: none"
              >
                üì∑ Capture
              </button>
              <button
                id="retake-btn"
                class="btn btn-secondary"
                style="display: none"
              >
                üîÑ Retake
              </button>
            </div>
          </div>
          <div
            id="captured-image-preview"
            class="image-preview"
            style="display: none"
          >
            <img id="captured-image" alt="Captured hazard" />
          </div>
        </div>

        <!-- Location Section -->
        <div class="location-section">
          <h2>üìç Location</h2>

          <!-- Google Map -->
          <div class="map-container">
            <iframe
              id="google-map"
              src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d15526.022196521722!2d121.1826176!3d13.3809924!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sen!2sph!4v1770049480412!5m2!1sen!2sph"
              width="100%"
              height="400"
              style="border: 0; border-radius: 8px"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              class="map-frame"
            >
            </iframe>
            <div class="map-instructions">
              <p>
                üìç Move the map to position the center marker, then click "Mark
                This Location"
              </p>
            </div>
          </div>

          <!-- Location Details -->
          <div class="location-details">
            <div class="location-coordinates">
              <p><strong>Latitude:</strong> <span id="latitude">--</span></p>
              <p><strong>Longitude:</strong> <span id="longitude">--</span></p>
            </div>

            <div class="location-address">
              <label for="location-details" class="required">
                <strong>Location Details *</strong>
              </label>
              <input
                type="text"
                id="location-details"
                placeholder="e.g., BLDG Rizal, 2nd Floor, Room 201"
                class="location-input"
                required
              />
              <small class="input-hint"
                >Please provide specific building/room details</small
              >
            </div>
          </div>

          <div
            id="location-status"
            class="location-status"
            style="display: none"
          >
            <p class="text-success">‚úÖ Location marked on map</p>
          </div>
          <div id="location-error" class="error-message" style="display: none">
            <p class="text-error">
              ‚ùå Please mark location on map and provide details
            </p>
          </div>
        </div>

        <!-- Description Section -->
        <div class="description-section" style="text-align: center;">
          <h2>üìù Description</h2>
          <textarea
            id="hazard-description"
            placeholder="Describe the hazard in detail (e.g., large pothole on main road, broken handrail on staircase, damaged stop sign at intersection)..."
            style="width: 100%; max-width: 600px; min-height: 150px; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; resize: vertical;"
            required
          ></textarea>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
          <button id="submit-report" class="btn btn-submit btn-lg" disabled>
            üì§ Submit Report
          </button>
          <div id="submit-status" class="submit-status"></div>
        </div>
      </div>

      <!-- Scripts -->
      <script src="{{ url_for('static', filename='js/camera.js') }}"></script>
      <script src="{{ url_for('static', filename='js/map-location.js') }}"></script>
    <script>
      // Report submission handler
      document
        .getElementById("submit-report")
        .addEventListener("click", async function () {
          const submitBtn = this;
          const statusDiv = document.getElementById("submit-status");

          // Validate all required fields
          const capturedImage = document.getElementById("captured-image").src;
          const latitude = document.getElementById("latitude-field")?.value;
          const longitude = document.getElementById("longitude-field")?.value;
          const locationDetails =
            document.getElementById("location-details")?.value;
          const description =
            document.getElementById("hazard-description").value;

          if (
            !capturedImage ||
            !latitude ||
            !longitude ||
            !locationDetails ||
            !description
          ) {
            statusDiv.innerHTML =
              '<p style="color: #dc3545;">‚ùå Please complete all required fields: photo, map location, location details, and description</p>';
            return;
          }

          // Prepare data
          const reportData = {
            before_image: capturedImage,
            latitude: parseFloat(latitude),
            longitude: parseFloat(longitude),
            description: description + "\n\nLocation: " + locationDetails,
          };

          // Show loading state
          submitBtn.disabled = true;
          submitBtn.textContent = "üì§ Submitting...";
          statusDiv.innerHTML =
            '<p class="text-info">‚è≥ Submitting report...</p>';

          try {
            const response = await fetch("/api/report", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(reportData),
            });

            const result = await response.json();

            if (response.ok && result.success) {
              statusDiv.innerHTML = `
                        <p class="text-success">‚úÖ Report submitted successfully!</p>
                        <p class="text-info">Report ID: #${result.report_id}</p>
                    `;

              // Reset form after delay
              setTimeout(() => {
                resetForm();
              }, 3000);
            } else {
              throw new Error(result.error || "Unknown error occurred");
            }
          } catch (error) {
            statusDiv.innerHTML = `<p class="text-error">‚ùå Error: ${error.message}</p>`;
            submitBtn.disabled = false;
            submitBtn.textContent = "üì§ Submit Report";
          }
        });

      function resetForm() {
        // Reset camera
        document.getElementById("camera-feed").style.display = "none";
        document.getElementById("capture-btn").style.display = "none";
        document.getElementById("retake-btn").style.display = "none";
        document.getElementById("start-camera").style.display = "inline-block";
        document.getElementById("captured-image-preview").style.display =
          "none";

        // Reset location using map manager
        if (window.mapLocationManager) {
          window.mapLocationManager.clearLocation();
        }

        // Reset description
        document.getElementById("hazard-description").value = "";

        // Reset submit button
        document.getElementById("submit-report").disabled = true;
        document.getElementById("submit-status").innerHTML = "";

        // Stop camera stream if active
        if (window.cameraStream) {
          window.cameraStream.getTracks().forEach((track) => track.stop());
          window.cameraStream = null;
        }
      }

      // Enable submit button when all fields are filled
      function checkFormComplete() {
        const capturedImage = document.getElementById("captured-image").src;
        const latitude = document.getElementById("latitude-field")?.value;
        const longitude = document.getElementById("longitude-field")?.value;
        const locationDetails =
          document.getElementById("location-details")?.value;
        const description = document.getElementById("hazard-description").value;

        const isComplete =
          capturedImage &&
          latitude &&
          longitude &&
          locationDetails &&
          description;
        document.getElementById("submit-report").disabled = !isComplete;
      }

      // Add event listeners for form validation
      document
        .getElementById("hazard-description")
        .addEventListener("input", checkFormComplete);

      // Add location details listener
      const locationDetailsInput = document.getElementById("location-details");
      if (locationDetailsInput) {
        locationDetailsInput.addEventListener("input", checkFormComplete);
      }

      // Initialize form check
      checkFormComplete();

      // CardNav Menu Functionality
      const hamburgerMenu = document.getElementById('hamburgerMenu');
      const cardNav = document.getElementById('cardNav');
      const cardNavContent = document.getElementById('cardNavContent');
      let isExpanded = false;

      function toggleMenu() {
        isExpanded = !isExpanded;
        
        if (isExpanded) {
          hamburgerMenu.classList.add('open');
          cardNav.classList.add('open');
          cardNavContent.setAttribute('aria-hidden', 'false');
          hamburgerMenu.setAttribute('aria-label', 'Close menu');
        } else {
          hamburgerMenu.classList.remove('open');
          cardNav.classList.remove('open');
          cardNavContent.setAttribute('aria-hidden', 'true');
          hamburgerMenu.setAttribute('aria-label', 'Open menu');
        }
      }

      hamburgerMenu.addEventListener('click', toggleMenu);
      
      // Keyboard accessibility
      hamburgerMenu.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleMenu();
        }
      });
    </script>
  </body>
</html>
