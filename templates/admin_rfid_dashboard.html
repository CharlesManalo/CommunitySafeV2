<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RFID Admin Dashboard - Infrastructure Reporting</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/cardnav.css') }}"
    />
    <style>
      .rfid-admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-card h3 {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
      }

      .dashboard-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e1e8ed;
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
      }

      .pin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .pin-card {
        background: #f8f9fa;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .pin-card.active {
        border-color: #28a745;
        background: #d4edda;
      }

      .pin-card.inactive {
        border-color: #dc3545;
        background: #f8d7da;
        opacity: 0.7;
      }

      .pin-number {
        font-size: 24px;
        font-weight: bold;
        font-family: monospace;
        letter-spacing: 4px;
        margin-bottom: 8px;
      }

      .pin-status {
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
      }

      .pin-actions {
        margin-top: 10px;
        display: flex;
        gap: 5px;
        justify-content: center;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
      }

      .logs-table {
        width: 100%;
        border-collapse: collapse;
      }

      .logs-table th,
      .logs-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }

      .logs-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      .logs-table tr:hover {
        background: #f8f9fa;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-teacher {
        background: #e9d5ff;
        color: #7c3aed;
      }

      .badge-student {
        background: #dbeafe;
        color: #2563eb;
      }

      .card-id {
        font-family: monospace;
        background: #f1f5f9;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
      }

      .add-pin-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .add-pin-form input {
        padding: 10px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 14px;
      }

      .add-pin-form input:focus {
        outline: none;
        border-color: #667eea;
      }

      .nav-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e1e8ed;
      }

      .nav-tab {
        padding: 12px 20px;
        text-decoration: none;
        color: #6c757d;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.3s ease;
      }

      .nav-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="rfid-admin-container">
      <!-- Header -->
      <header style="margin-bottom: 30px">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1 style="font-size: 28px; margin-bottom: 5px">
              üì° RFID Admin Dashboard
            </h1>
            <p style="color: #6c757d">
              Monitor access logs and manage teacher PINs
            </p>
          </div>
          <div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary"
              >‚Üê Back to Admin Dashboard</a
            >
            <a
              href="{{ url_for('admin_logout') }}"
              class="btn btn-logout"
              style="margin-left: 10px"
              >Logout</a
            >
          </div>
        </div>
      </header>

      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <a href="#overview" class="nav-tab active" onclick="showTab('overview')"
          >Overview</a
        >
        <a href="#pins" class="nav-tab" onclick="showTab('pins')"
          >Teacher PINs</a
        >
        <a href="#logs" class="nav-tab" onclick="showTab('logs')"
          >Access Logs</a
        >
      </div>

      <!-- Overview Tab -->
      <div id="overview-tab" class="tab-content">
        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Scans</h3>
            <p class="stat-number">{{ stats.total_scans or 0 }}</p>
          </div>
          <div
            class="stat-card"
            style="
              background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            "
          >
            <h3>Today's Scans</h3>
            <p class="stat-number">{{ stats.today_scans or 0 }}</p>
          </div>
          <div
            class="stat-card"
            style="
              background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            "
          >
            <h3>Teacher Access</h3>
            <p class="stat-number">{{ stats.teacher_scans or 0 }}</p>
          </div>
          <div
            class="stat-card"
            style="
              background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
            "
          >
            <h3>Student Access</h3>
            <p class="stat-number">{{ stats.student_scans or 0 }}</p>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
          <div class="section-header">
            <h2 class="section-title">‚ö° Quick Actions</h2>
          </div>
          <div style="display: flex; gap: 15px">
            <a href="#pins" onclick="showTab('pins')" class="btn btn-primary"
              >Manage PINs</a
            >
            <a href="#logs" onclick="showTab('logs')" class="btn btn-secondary"
              >View Logs</a
            >
            <a
              href="{{ url_for('rfid_landing') }}"
              target="_blank"
              class="btn btn-success"
              >Open RFID Scanner</a
            >
          </div>
        </div>

        <!-- Recent Activity Preview -->
        <div class="dashboard-section">
          <div class="section-header">
            <h2 class="section-title">üïê Recent Activity</h2>
            <a
              href="#logs"
              onclick="showTab('logs')"
              class="btn btn-sm btn-secondary"
              >View All</a
            >
          </div>
          {% if logs %}
          <table class="logs-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Card ID</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs[:5] %}
              <tr>
                <td>{{ log.scan_timestamp }}</td>
                <td>
                  <span class="badge badge-{{ log.user_type }}"
                    >{{ log.user_type.title() }}</span
                  >
                </td>
                <td>
                  <span class="card-id"
                    >{{ log.card_id[:8] }}...{{ log.card_id[-4:] if
                    log.card_id|length > 12 else '' }}</span
                  >
                </td>
                <td>
                  {% if log.is_verified %}
                  <span style="color: #28a745">‚úì Verified</span>
                  {% else %}
                  <span style="color: #dc3545">‚úó Failed</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="empty-state">
            <p>No scan activity yet</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- PINs Tab -->
      <div id="pins-tab" class="tab-content" style="display: none">
        <div class="dashboard-section">
          <div class="section-header">
            <h2 class="section-title">üîê Teacher PIN Management</h2>
          </div>

          <!-- Add New PIN Form -->
          <div class="add-pin-form">
            <input
              type="text"
              id="new-pin"
              placeholder="4-digit PIN"
              maxlength="4"
              pattern="\d{4}"
            />
            <input
              type="text"
              id="teacher-name"
              placeholder="Teacher Name"
              style="flex: 1"
            />
            <button onclick="addPin()" class="btn btn-primary">Add PIN</button>
          </div>

          <!-- PIN Grid -->
          <div class="pin-grid">
            {% for pin in pins %}
            <div
              class="pin-card {{ 'active' if pin.is_active else 'inactive' }}"
            >
              <div class="pin-number">{{ pin.pin }}</div>
              <div class="pin-status">
                {{ 'Active' if pin.is_active else 'Inactive' }}
              </div>
              <div style="font-size: 12px; color: #6c757d; margin-top: 5px">
                {{ pin.teacher_name or 'Unnamed' }}
              </div>
              <div class="pin-actions">
                <button
                  onclick="togglePin('{{ pin.id }}')"
                  class="btn btn-sm {{ 'btn-secondary' if pin.is_active else 'btn-primary' }}"
                >
                  {{ 'Disable' if pin.is_active else 'Enable' }}
                </button>
                <button
                  onclick="deletePin('{{ pin.id }}')"
                  class="btn btn-sm btn-logout"
                >
                  Delete
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logs-tab" class="tab-content" style="display: none">
        <div class="dashboard-section">
          <div class="section-header">
            <h2 class="section-title">üìã Access Logs</h2>
            <div>
              <button onclick="refreshLogs()" class="btn btn-secondary">
                üîÑ Refresh
              </button>
            </div>
          </div>

          {% if logs %}
          <div style="overflow-x: auto">
            <table class="logs-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Timestamp</th>
                  <th>User Type</th>
                  <th>Card ID (Full)</th>
                  <th>Card Data</th>
                  <th>Teacher PIN</th>
                  <th>IP Address</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="logs-table-body">
                {% for log in logs %}
                <tr>
                  <td>#{{ log.id }}</td>
                  <td>{{ log.scan_timestamp }}</td>
                  <td>
                    <span class="badge badge-{{ log.user_type }}"
                      >{{ log.user_type.title() }}</span
                    >
                  </td>
                  <td><span class="card-id">{{ log.card_id }}</span></td>
                  <td>{{ log.card_data or '-' }}</td>
                  <td>{{ log.teacher_pin or '-' }}</td>
                  <td>{{ log.ip_address or '-' }}</td>
                  <td>
                    {% if log.is_verified %}
                    <span style="color: #28a745; font-weight: 600"
                      >‚úì Verified</span
                    >
                    {% else %}
                    <span style="color: #dc3545; font-weight: 600"
                      >‚úó Failed</span
                    >
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state">
            <p>üì≠ No access logs found</p>
            <p style="font-size: 14px; margin-top: 10px">
              Scan activity will appear here
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.style.display = "none";
        });

        // Show selected tab
        document.getElementById(tabName + "-tab").style.display = "block";

        // Update nav
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");
      }

      // Add new PIN
      async function addPin() {
        const pin = document.getElementById("new-pin").value;
        const teacherName = document.getElementById("teacher-name").value;

        if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
          alert("Please enter a valid 4-digit PIN");
          return;
        }

        try {
          const response = await fetch("/api/admin/pins", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pin, teacher_name: teacherName }),
          });

          if (response.ok) {
            alert("PIN added successfully");
            location.reload();
          } else {
            const data = await response.json();
            alert(data.error || "Failed to add PIN");
          }
        } catch (error) {
          alert("Error adding PIN");
        }
      }

      // Toggle PIN status
      async function togglePin(pinId) {
        try {
          const response = await fetch(
            `/api/admin/pins/${parseInt(pinId)}/toggle`,
            {
              method: "POST",
            },
          );

          if (response.ok) {
            location.reload();
          } else {
            alert("Failed to toggle PIN");
          }
        } catch (error) {
          alert("Error toggling PIN");
        }
      }

      // Delete PIN
      async function deletePin(pinId) {
        if (!confirm("Are you sure you want to delete this PIN?")) return;

        try {
          const response = await fetch(`/api/admin/pins/${parseInt(pinId)}`, {
            method: "DELETE",
          });

          if (response.ok) {
            location.reload();
          } else {
            alert("Failed to delete PIN");
          }
        } catch (error) {
          alert("Error deleting PIN");
        }
      }

      // Refresh logs
      async function refreshLogs() {
        try {
          const response = await fetch("/api/admin/rfid-logs");
          const data = await response.json();

          if (data.success) {
            // Update table with new logs
            location.reload();
          }
        } catch (error) {
          console.error("Error refreshing logs:", error);
        }
      }

      // Auto-refresh logs every 30 seconds
      setInterval(() => {
        if (document.getElementById("logs-tab").style.display !== "none") {
          refreshLogs();
        }
      }, 30000);

      // CardNav Menu Functionality
      const hamburgerMenu = document.getElementById("hamburgerMenu");
      const cardNav = document.getElementById("cardNav");
      const cardNavContent = document.getElementById("cardNavContent");
      let isExpanded = false;

      function toggleMenu() {
        isExpanded = !isExpanded;

        if (isExpanded) {
          hamburgerMenu.classList.add("open");
          cardNav.classList.add("open");
          cardNavContent.setAttribute("aria-hidden", "false");
          hamburgerMenu.setAttribute("aria-label", "Close menu");
        } else {
          hamburgerMenu.classList.remove("open");
          cardNav.classList.remove("open");
          cardNavContent.setAttribute("aria-hidden", "true");
          hamburgerMenu.setAttribute("aria-label", "Open menu");
        }
      }

      hamburgerMenu.addEventListener("click", toggleMenu);

      // Keyboard accessibility
      hamburgerMenu.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleMenu();
        }
      });
    </script>
  </body>
</html>
